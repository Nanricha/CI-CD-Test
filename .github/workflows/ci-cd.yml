name: CI/CD â€” Salesforce (sf CLI)

on:
  push:
    branches: [ master ]
  pull_request:
    branches: [ master ]

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Salesforce CLI
        run: |
          npm install --global @salesforce/cli
          sf --version

      - name: Authenticate to Salesforce (JWT)
        env:
          SF_CLIENT_ID: ${{ secrets.SF_CLIENT_ID }}
          SF_JWT_KEY: ${{ secrets.SF_JWT_KEY }}
          SF_USERNAME: ${{ secrets.SF_USERNAME }}
        run: |
          echo "$SF_JWT_KEY" > jwt.key
          sf org login jwt --client-id "$SF_CLIENT_ID" --jwt-key-file jwt.key --username "$SF_USERNAME" --instance-url https://login.salesforce.com --alias ci-org

      - name: Run unit tests
        run: |
          sf apex run test --test-level RunLocalTests --target-org ci-org --wait 10

      - name: Deploy source
        run: |
          sf project deploy start --source-dir force-app --target-org ci-org --test-level RunLocalTests --wait 10
